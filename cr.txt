import requests
from datetime import datetime, timedelta
from azure.identity import ClientSecretCredential

def fetch_alerts(subscription_id):
    # Calculate start and end time for the last 5 minutes in UTC
    end_time_utc = datetime.utcnow()
    start_time_utc = end_time_utc - timedelta(minutes=5)
    
    # Format start and end time as UTC string in ISO 8601 format
    start_time_str = start_time_utc.strftime("%Y-%m-%dT%H:%M:%SZ")
    end_time_str = end_time_utc.strftime("%Y-%m-%dT%H:%M:%SZ")
    
    # Azure Monitor Alerts Management API endpoint URL
    url = f"https://management.azure.com/subscriptions/{subscription_id}/providers/Microsoft.AlertsManagement/alerts?customTimeRange={start_time_str}/{end_time_str}&api-version=2023-07-12-preview"
    
    # Azure AD access token
    access_token = "<Your Access Token>"
    
    # Request headers with access token
    headers = {
        "Authorization": f"Bearer {access_token}"
    }
    
    try:
        # Sending HTTP GET request to fetch alerts
        response = requests.get(url, headers=headers)
        
        # Checking if request was successful (status code 200)
        if response.status_code == 200:
            # Parsing JSON response
            alerts = response.json()
            return alerts
        else:
            # Printing error message if request fails
            print("Failed to fetch alerts. Status code:", response.status_code)
            print("Response:", response.text)
            return None
    except Exception as e:
        # Printing error message if an exception occurs
        print("An error occurred:", e)
        return None

if __name__ == "__main__":
    # Calling the fetch_alerts function to retrieve alerts
    subscription_id = "<Your Subscription ID>"
    alerts = fetch_alerts(subscription_id)
    
    # Printing the fetched alerts
    if alerts:
        print(alerts)
