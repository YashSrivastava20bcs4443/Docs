import requests
import json
from datetime import datetime, timedelta
from azure.identity import ClientSecretCredential

def get_alerts():
    # Azure Active Directory authentication ke liye client credentials ko set karna
    credentials = ClientSecretCredential(
        client_id="<Your Client ID>",
        client_secret="<Your Client Secret>",
        tenant_id="<Your Tenant ID>"
    )

    # Authentication token prapt karna
    token = credentials.get_token('https://management.azure.com/')

    # Last 5 minutes ka start time calculate karna
    end_time = datetime.utcnow()
    start_time = end_time - timedelta(minutes=5)

    # REST API endpoint aur query
    endpoint = "https://management.azure.com/subscriptions/{subscription_id}/providers/microsoft.insights/metricAlerts?api-version=2018-03-01&$filter=properties/createdTime ge '{start_time}'"
    subscription_id = "<Your Subscription ID>"
    url = endpoint.format(subscription_id=subscription_id, start_time=start_time.strftime("%Y-%m-%dT%H:%M:%SZ"))

    headers = {
        "Authorization": "Bearer " + token.token,
        "Content-Type": "application/json"
    }

    # REST API call
    response = requests.get(url, headers=headers)

    # Response parse kar alerts ko extract karna
    if response.status_code == 200:
        alerts = json.loads(response.text)
        return alerts
    else:
        print("Failed to fetch alerts. Status code:", response.status_code)

if __name__ == "__main__":
    alerts = get_alerts()
    print(alerts)
