import requests
from datetime import datetime, timedelta
from azure.identity import ClientSecretCredential

def get_token():
    credentials = ClientSecretCredential(
        client_id="<Your Client ID>",
        client_secret="<Your Client Secret>",
        tenant_id="<Your Tenant ID>"
    )
    token = credentials.get_token("https://management.azure.com/.default")
    return token.token

def get_alerts():
    endpoint = "<Your Endpoint URL>"
    
    try:
        token = get_token()
        headers = {
            "Authorization": "Bearer " + token
        }

        # Calculate start and end time for the last 5 minutes
        end_time = datetime.utcnow()
        start_time = end_time - timedelta(minutes=5)

        # Include the time filter in the endpoint URL
        url = f"{endpoint}&start_time={start_time.isoformat()}Z&end_time={end_time.isoformat()}Z"

        # REST API call
        response = requests.get(url, headers=headers)

        # Response parse kar alerts ko extract karna
        if response.status_code == 200:
            alerts = response.json()
            return alerts
        else:
            print("Failed to fetch alerts. Status code:", response.status_code)
            print("Response:", response.text)
            return None
    except Exception as e:
        print("An error occurred:", e)
        return None

if __name__ == "__main__":
    alerts = get_alerts()
    print(alerts)
