def main():
    # Fetch alerts
    subscription_id = "<Your Subscription ID>"
    alerts = fetch_alerts(subscription_id)

    # Save alerts to JSON file
    save_to_json(alerts)

    # Read CSV file
    with open("api_owners.csv", newline="") as csvfile:
        reader = csv.DictReader(csvfile)
        api_owners = {row["API_Name"]: row["Owner_Email"] for row in reader}

    # Initialize Selenium WebDriver
    options = webdriver.ChromeOptions()
    options.add_argument("--headless")  # Run in headless mode
    driver = webdriver.Chrome(options=options)

    # Iterate over alerts
    for alert in alerts:
        target_resource_name = alert["targetResourceName"]
        if target_resource_name in api_owners:
            owner_email = api_owners[target_resource_name]

            # Open Azure portal and sign in
            driver.get("https://portal.azure.com")
            driver.find_element_by_id("i0116").send_keys("your_username")  # Enter your Azure username
            driver.find_element_by_id("idSIButton9").click()  # Click on the next button
            driver.find_element_by_id("i0118").send_keys("your_password")  # Enter your Azure password
            driver.find_element_by_id("idSIButton9").click()  # Click on the next button
            driver.find_element_by_id("idSIButton9").click()  # Click on the next button (Stay signed in)

            # Wait for the dashboard to load
            WebDriverWait(driver, 10).until(EC.presence_of_element_located((By.ID, "dashboard")))

            # Capture screenshot
            screenshot_filename = f"{target_resource_name}.png"
            driver.save_screenshot(screenshot_filename)

            # Send email
            send_email(target_resource_name, owner_email, screenshot_filename, alert["severity"], alert["name"])

    # Quit WebDriver
    driver.quit()

if __name__ == "__main__":
    main()
