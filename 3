import pandas as pd

# Load the Excel sheets
sentinel_file = 'sentinel.xlsx'
sccm_file = 'sccm.xlsx'

# Read data from Excel files
sentinel = pd.read_excel(sentinel_file)
sccm = pd.read_excel(sccm_file)

# Normalize column names for consistency
sentinel.columns = sentinel.columns.str.lower().str.strip()
sccm.columns = sccm.columns.str.lower().str.strip()

# Define common columns
common_columns = ['hostname', 'serialnumber', 'model', 'operating system', 'username', 'ip']

# Perform an inner join on hostname and serialnumber
merged_data = pd.merge(
    sentinel, sccm, 
    on=['hostname', 'serialnumber'], 
    suffixes=('_sentinel', '_sccm')
)

# Debug: Print merged columns to verify the structure
print("Merged DataFrame Columns:")
print(merged_data.columns)

# Fill missing values in common columns from sccm to sentinel
for column in common_columns:
    sentinel_col = f'{column}_sentinel'
    sccm_col = f'{column}_sccm'
    if sentinel_col in merged_data.columns and sccm_col in merged_data.columns:
        # Fill missing data in sentinel with data from sccm
        merged_data[column] = merged_data[sentinel_col].combine_first(merged_data[sccm_col])
    else:
        print(f"Column '{column}' not found in both data sources. Skipping.")

# Drop duplicate columns (from sccm)
columns_to_drop = [f"{col}_sccm" for col in common_columns if f"{col}_sccm" in merged_data.columns]
merged_data = merged_data.drop(columns=columns_to_drop, errors='ignore')

# Drop original sentinel columns to keep only the merged ones
columns_to_drop = [f"{col}_sentinel" for col in common_columns if f"{col}_sentinel" in merged_data.columns]
merged_data = merged_data.drop(columns=columns_to_drop, errors='ignore')

# Save the resulting data to a new Excel file
output_file = 'merged_data.xlsx'
merged_data.to_excel(output_file, index=False)

print(f"Data merged and saved successfully to '{output_file}'.")
