trigger:
- main

parameters:
  - name: osType
    displayName: "OS Type"
    type: string
    default: "linux"
    values:
      - linux
      - windows

  # Linux VM Parameters
  - name: linuxVmSize
    displayName: "Linux VM Size"
    type: string
    default: "Standard_D2s_v3"
    values:
      - Standard_D2s_v3
      - Standard_B2s
      - Standard_F2

  - name: linuxNicCount
    displayName: "Number of NICs (Linux)"
    type: number
    default: 1

  - name: linuxVmCount
    displayName: "Number of Linux VMs"
    type: number
    default: 1

  # Windows VM Parameters
  - name: windowsVmSize
    displayName: "Windows VM Size"
    type: string
    default: "Standard_D2s_v3"
    values:
      - Standard_D2s_v3
      - Standard_B2s
      - Standard_F2

  - name: windowsNicCount
    displayName: "Number of NICs (Windows)"
    type: number
    default: 0

  - name: windowsVmCount
    displayName: "Number of Windows VMs"
    type: number
    default: 0

jobs:
- job: Terraform_Deploy
  displayName: "Terraform Apply"
  pool:
    vmImage: 'ubuntu-latest'

  steps:
  - checkout: self

  - task: TerraformTaskV3@3
    displayName: "Terraform Init"
    inputs:
      provider: "azurerm"
      command: "init"
      backendServiceArm: "AzureConnection"
      backendAzureRmResourceGroupName: "tfstate-resources"
      backendAzureRmStorageAccountName: "mytfstatesstacc"
      backendAzureRmContainerName: "tfstate"
      backendAzureRmKey: "VM_TS_module/terraform.tfstate"

  - task: TerraformTaskV3@3
    displayName: "Terraform Plan"
    inputs:
      provider: "azurerm"
      command: "plan"
      backendServiceArm: "AzureConnection"
      commandOptions: >
        -var="linux_vm_count=${{ parameters.linuxVmCount }}" 
        -var="windows_vm_count=${{ parameters.windowsVmCount }}" 
        -var="linux_vm_config.vm_size=${{ parameters.linuxVmSize }}" 
        -var="linux_vm_config.nic_count=${{ parameters.linuxNicCount }}" 
        -var="windows_vm_config.vm_size=${{ parameters.windowsVmSize }}" 
        -var="windows_vm_config.nic_count=${{ parameters.windowsNicCount }}"

  - task: TerraformTaskV3@3
    displayName: "Terraform Apply"
    inputs:
      provider: "azurerm"
      command: "apply"
      backendServiceArm: "AzureConnection"
      commandOptions: >
        -var="linux_vm_count=${{ parameters.linuxVmCount }}" 
        -var="windows_vm_count=${{ parameters.windowsVmCount }}" 
        -var="linux_vm_config.vm_size=${{ parameters.linuxVmSize }}" 
        -var="linux_vm_config.nic_count=${{ parameters.linuxNicCount }}" 
        -var="windows_vm_config.vm_size=${{ parameters.windowsVmSize }}" 
        -var="windows_vm_config.nic_count=${{ parameters.windowsNicCount }}"
      runAzLogin: false
