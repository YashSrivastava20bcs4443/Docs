# Define the URLs for the installer and the vault registration key
$installerUrl = "https://aka.ms/ASR-HyperV-Provider" # URL for the ASR Provider installer
$vaultKeyUrl = "https://<your-vault-key-url>" # Replace with your vault registration key URL

# Define the paths to save the downloaded files
$installerPath = "C:\Temp\ASRProviderInstaller.exe"
$vaultKeyPath = "C:\Temp\VaultRegistrationKey.json"

# List of servers to install the ASR Provider
$servers = @("Server1", "Server2", "Server3") # Add your server names here

# Function to download files
function Download-File($url, $outputPath) {
    Invoke-WebRequest -Uri $url -OutFile $outputPath
}

# Function to install ASR Provider on a server
function Install-ASRProvider {
    param (
        [string]$server,
        [string]$installerPath,
        [string]$vaultKeyPath
    )

    Invoke-Command -ComputerName $server -ScriptBlock {
        param (
            $installerPath,
            $vaultKeyPath
        )

        # Install the ASR Provider
        Start-Process -FilePath $installerPath -ArgumentList "/q" -Wait

        # Register the server with the vault using the vault registration key
        Start-Process -FilePath "C:\Program Files\Microsoft Azure Site Recovery Provider\AzureSiteRecoveryProvider.exe" -ArgumentList "/q /RegKeyFile:$vaultKeyPath" -Wait
    } -ArgumentList $installerPath, $vaultKeyPath -Credential (Get-Credential)
}

# Download the installer and vault registration key
Download-File -url $installerUrl -outputPath $installerPath
Download-File -url $vaultKeyUrl -outputPath $vaultKeyPath

# Install ASR Provider on each server
foreach ($server in $servers) {
    Install-ASRProvider -server $server -installerPath $installerPath -vaultKeyPath $vaultKeyPath
}
