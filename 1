# Weekly Alerts Analysis (Grouped Bar Chart: Day of Week on X-axis, Weeks Grouped)
st.subheader("Weekly Alerts Analysis")

if not filtered_data.empty:
    # Add Week number to the data
    filtered_data['WeekNumber'] = filtered_data['@timestamp'].dt.isocalendar().week

    # Group by Day of the week and Week number
    weekly_alerts = filtered_data.groupby(['Weekday', 'WeekNumber']).size().unstack(fill_value=0)

    # Sort the index (weekdays) in correct order
    weekday_order = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday']
    weekly_alerts = weekly_alerts.reindex(weekday_order)

    # Plot grouped bar chart
    fig, ax = plt.subplots(figsize=(12, 6))
    weekly_alerts.plot(kind='bar', ax=ax, colormap='tab10', width=0.8)

    # Handling the case where multiple sources are selected
    sources_display = ", ".join(selected_sources) if len(selected_sources) > 1 else selected_sources[0]

    ax.set_title(f"Weekly Alerts Analysis: Comparison of Weeks for Each Day for {sources_display}")
    ax.set_xlabel("Day of the Week")
    ax.set_ylabel("Number of Alerts")
    ax.legend(title="Week Number")

    # Displaying values on top of each bar
    for container in ax.containers:
        ax.bar_label(container, fmt='%d', label_type='edge', fontsize=8, padding=3)

    st.pyplot(fig)
else:
    st.write("No data available for the selected filters.")
