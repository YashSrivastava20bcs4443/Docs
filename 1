SELECT 
    "toAddress" AS "Number (toAddress)",  

    COUNT(*) AS offered_calls,

    SUM(CASE 
            WHEN CAST(NULLIF("abandoned", '') AS BOOLEAN) = TRUE 
                 AND (NULLIF("inQueueSeconds", '') IS NULL OR NULLIF("inQueueSeconds", '') = '' OR NULLIF("inQueueSeconds", '')::FLOAT::INTEGER = 0) 
            THEN 1 ELSE 0 
        END) AS ivr_abandon,

    SUM(CASE 
            WHEN CAST(NULLIF("abandoned", '') AS BOOLEAN) = TRUE 
                 AND NULLIF("inQueueSeconds", '') ~ '^[0-9]+(\.[0-9]+)?$'  
            THEN NULLIF("inQueueSeconds", '')::FLOAT::INTEGER ELSE 0 
        END) AS queue_abandon,

    SUM(CASE 
            WHEN CAST(NULLIF("abandoned", '') AS BOOLEAN) = TRUE 
                 AND "endReason" IN ('Contact Hung Up', 'Contact Hang Up via Script') 
            THEN 1 ELSE 0 
        END) AS polite_disconnect,

    COUNT(*) FILTER (WHERE NULLIF("agentSeconds", '') ~ '^[0-9]+(\.[0-9]+)?$' AND NULLIF("agentSeconds", '')::FLOAT::INTEGER > 0) AS answered_calls

FROM contact_data
GROUP BY "toAddress"
ORDER BY offered_calls DESC;
