# Set your Azure resource group and DNS zone names
$resourceGroupName = "demo-resource-YS"
$dnsZoneName = "my.internal.dns"

# Log in to Azure (interactive login)
Connect-AzAccount

# Retrieve all VMs in the resource group
$vms = Get-AzVM -ResourceGroupName $resourceGroupName

# Debug: Output all VMs and their tags
Write-Output "All VMs in the Resource Group:"
$vms | ForEach-Object {
    Write-Output "VM Name: $($_.Name)"
    Write-Output "Tags: $($_.Tags)"
}

# Filter VMs based on the specified tags
$filteredVms = $vms | Where-Object {
    $_.Tags["resource_type"] -eq "virtual_machine" -and
    $_.Tags["environment"] -eq "dr" -and
    $_.Tags["cost_center"] -eq "it" -and
    $_.Tags["service"] -eq "vm"
}

# Debug: Output the filtered VMs
Write-Output "Filtered VMs based on Tags:"
$filteredVms | ForEach-Object { Write-Output $_.Name }

# Check if any VMs were retrieved
if ($filteredVms.Count -eq 0) {
    Write-Output "No VMs found with the specified tags."
    exit
}

# Loop through each filtered VM to create DNS records
foreach ($vm in $filteredVms) {
    # Get the VM's private IP address
    $networkInterfaceName = $vm.NetworkProfile.NetworkInterfaces.Id.Split('/')[-1]
    $networkInterface = Get-AzNetworkInterface -ResourceGroupName $resourceGroupName -Name $networkInterfaceName
    $privateIp = $networkInterface.IpConfigurations.PrivateIpAddress

    # Debug: Output the network interface and private IP
    Write-Output "VM Name: $($vm.Name)"
    Write-Output "Network Interface Name: $networkInterfaceName"
    Write-Output "Private IP: $privateIp"

    # Set the DNS record name (you can customize this as needed)
    $dnsRecordName = $vm.Name

    # Debug: Output the DNS record being created
    Write-Output "Creating DNS record: $dnsRecordName with IP: $privateIp"

    # Create the DNS record in the private DNS zone
    New-AzPrivateDnsRecordSet -ResourceGroupName $resourceGroupName -ZoneName $dnsZoneName -Name $dnsRecordName -RecordType A -Ttl 3600 -PrivateDnsRecords (New-AzPrivateDnsRecordConfig -Ipv4Address $privateIp)
}

Write-Output "DNS records have been created for the VMs."
