import pandas as pd
import matplotlib.pyplot as plt

# Step 1: Read data from Excel
file_path = 'data.xlsx'  # Replace with your actual file path
sheet_name = 'Sheet1'  # Replace with your Excel sheet name

# Read the Excel file
df = pd.read_excel(file_path, sheet_name=sheet_name)

# Step 2: Clean and process the data
# Clean the @timestamp column
df['@timestamp'] = df['@timestamp'].str.replace('@', '').str.strip()

# Convert the cleaned @timestamp to datetime
df['@timestamp'] = pd.to_datetime(df['@timestamp'], format='%b %d, %Y %H:%M:%S.%f')

# Extract Time
df['Time'] = df['@timestamp'].dt.floor('H')  # Group by hour for better visualization

# Group data for stacked bar chart
timewise_alerts = df.groupby(['Time', 'EventSource'])['EventLevel'].count().unstack(fill_value=0)

# Calculate cumulative alerts (for line chart)
timewise_alerts['Cumulative'] = timewise_alerts.sum(axis=1).cumsum()

# Step 3: Plot Stacked Bar Chart with Line Chart
fig, ax1 = plt.subplots(figsize=(12, 8))

# Stacked Bar Chart
timewise_alerts.iloc[:, :-1].plot(kind='bar', stacked=True, ax=ax1, colormap='tab20')

# Line Chart (Cumulative Alerts)
ax2 = ax1.twinx()
ax2.plot(timewise_alerts.index, timewise_alerts['Cumulative'], color='black', marker='o', linewidth=2, label='Cumulative Alerts')

# Customizing the plot
ax1.set_title('Time-wise Alerts (Stacked Bar) with Cumulative Alerts (Line)')
ax1.set_xlabel('Time')
ax1.set_ylabel('Number of Alerts')
ax2.set_ylabel('Cumulative Alerts')

ax1.legend(loc='upper left', bbox_to_anchor=(1.05, 1))
ax2.legend(loc='upper left', bbox_to_anchor=(1.05, 0.9))

plt.xticks(rotation=45)
plt.tight_layout()
plt.show()

# Optional: Display processed data
print("Processed DataFrame:")
print(timewise_alerts)
