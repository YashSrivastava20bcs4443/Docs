SELECT 
    toll_number,
    COALESCE(ivr_offered_count, 0) AS offered_calls,
    COALESCE(ivr_offered_count - ivr_abandoned_count, 0) AS answered,
    COALESCE(ivr_abandoned_count, 0) AS ivr_abandon,
    COALESCE(queue_abandon_count, 0) AS queue_abandon,
    COALESCE(polite_disconnect_count, 0) AS polite_disconnect
FROM (
    SELECT DISTINCT (data->>'toAddress') AS toll_number
    FROM raw_api_data
) toll_numbers
LEFT JOIN (
    SELECT 
        (data->>'toAddress') AS toll_number,
        COUNT(*) AS ivr_offered_count
    FROM raw_api_data
    WHERE (data->>'mediaTypeId')::INTEGER = 4
      AND (data->>'isOutbound')::BOOLEAN = FALSE
      AND (data->>'masterContactId') = (data->>'contactId')
    GROUP BY (data->>'toAddress')
) ivr_offered ON toll_numbers.toll_number = ivr_offered.toll_number
LEFT JOIN (
    SELECT 
        (data->>'toAddress') AS toll_number,
        COUNT(*) AS ivr_abandoned_count
    FROM raw_api_data
    WHERE (data->>'mediaTypeId')::INTEGER = 4
      AND (data->>'isOutbound')::BOOLEAN = FALSE
      AND (data->>'abandoned')::BOOLEAN = FALSE
      AND (data->>'masterContactId') = (data->>'contactId')
      AND (data->>'agentSeconds')::NUMERIC = 0
      AND (data->>'inQueueSeconds')::NUMERIC = 0
      AND (data->>'preQueueSeconds')::NUMERIC > 1
      AND (data->>'endReason') = 'Contact Hung Up'
    GROUP BY (data->>'toAddress')
) ivr_abandoned ON toll_numbers.toll_number = ivr_abandoned.toll_number
LEFT JOIN (
    SELECT 
        (data->>'toAddress') AS toll_number,
        COUNT(*) AS polite_disconnect_count
    FROM raw_api_data
    WHERE (data->>'mediaTypeId')::INTEGER = 4
      AND (data->>'isOutbound')::BOOLEAN = FALSE
      AND (data->>'abandoned')::BOOLEAN = FALSE
      AND (data->>'masterContactId') = (data->>'contactId')
      AND (data->>'agentSeconds')::NUMERIC = 0
      AND (data->>'inQueueSeconds')::NUMERIC = 0
      AND (data->>'preQueueSeconds')::NUMERIC > 1
      AND (data->>'endReason') = 'Contact Hang Up via Script'
    GROUP BY (data->>'toAddress')
) polite_disconnect ON toll_numbers.toll_number = polite_disconnect.toll_number
LEFT JOIN (
    SELECT 
        (data->>'toAddress') AS toll_number,
        COUNT(*) AS queue_abandon_count
    FROM raw_api_data
    WHERE (data->>'mediaTypeId')::INTEGER = 4
      AND (data->>'isOutbound')::BOOLEAN = TRUE
      AND (data->>'abandoned')::BOOLEAN = FALSE
      AND (data->>'masterContactId') = (data->>'contactId')
      AND (data->>'agentSeconds')::NUMERIC = 0
      AND (data->>'inQueueSeconds')::NUMERIC > 0
      AND (data->>'preQueueSeconds')::NUMERIC > 0
    GROUP BY (data->>'toAddress')
) queue_abandon ON toll_numbers.toll_number = queue_abandon.toll_number;
