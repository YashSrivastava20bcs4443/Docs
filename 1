import json
from elasticsearch import Elasticsearch
from demo_config import e_password, e_username, elasticsearch_url

# Elasticsearch client setup
es = Elasticsearch(
    [elasticsearch_url],
    basic_auth=(e_username, e_password)
)

# Function to fetch alerts and save to JSON
def fetch_and_save_alerts():
    common_index = "common-events-*"
    payload = {
        "query": {
            "bool": {
                "must": [
                    {"range": {
                        "@timestamp": {
                            "gte": "now-41d",
                            "lte": "now",
                            "format": "strict_date_optional_time"
                        }
                    }},
                    {"match": {"EventSource": "Airflow"}}
                ]
            }
        },
        "sort": [{"@timestamp": {"order": "desc"}}],
        "size": 10000  # Maximum number of results per query
    }

    try:
        # Perform search query
        result = es.search(index=common_index, body=payload)
        if result['hits']['total']['value'] > 0:
            alerts = [hit['_source'] for hit in result['hits']['hits']]

            # Save the data to a JSON file
            with open("airflow_alerts.json", "w") as json_file:
                json.dump(alerts, json_file, indent=4)

            print(f"Saved {len(alerts)} alerts to 'airflow_alerts.json'")
        else:
            print("No alerts found.")
    except Exception as e:
        print(f"Error fetching alerts: {e}")

# Main function
def process_alerts():
    fetch_and_save_alerts()

if __name__ == "__main__":
    process_alerts()
