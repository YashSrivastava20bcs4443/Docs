import os
import csv
import paramiko
import matplotlib.pyplot as plt
import smtplib
from email.mime.text import MIMEText
from email.mime.multipart import MIMEMultipart
from email.mime.image import MIMEImage

# Fetch CSV from SFTP server
def fetch_csv_from_sftp(sftp_details, remote_file, local_file):
    try:
        # Connect to SFTP
        transport = paramiko.Transport((sftp_details['host'], sftp_details['port']))
        transport.connect(username=sftp_details['username'], password=sftp_details['password'])
        sftp = paramiko.SFTPClient.from_transport(transport)

        # Fetch the file
        sftp.get(remote_file, local_file)
        print(f"CSV file fetched: {local_file}")
        sftp.close()
        transport.close()
    except Exception as e:
        print(f"Error fetching CSV file: {e}")

# Generate separate graphs for SPA and SPB utilization
def generate_graphs(csv_file, spa_output_image, spb_output_image):
    """Generate separate graphs for SPA and SPB utilization from the CSV data."""
    timestamps = []
    spa_utilizations = []
    spb_utilizations = []

    # Read CSV data
    with open(csv_file, "r") as file:
        reader = csv.DictReader(file)
        for row in reader:
            timestamps.append(row["Timestamp(GMT)"])
            spa_utilizations.append(float(row["SPA Utilisation (%)"]))
            spb_utilizations.append(float(row["SPB Utilisation (%)"]))

    # Plot SPA Utilisation
    plt.figure(figsize=(10, 6))
    plt.plot(timestamps, spa_utilizations, label="SPA Utilisation (%)", marker="o", color="blue")
    plt.xlabel("Timestamp (GMT)")
    plt.ylabel("Utilisation (%)")
    plt.title("SPA Utilisation Over Time")
    plt.xticks(rotation=45, ha="right")
    plt.tight_layout()
    plt.grid()
    plt.savefig(spa_output_image)
    plt.close()
    print(f"SPA graph generated: {spa_output_image}")

    # Plot SPB Utilisation
    plt.figure(figsize=(10, 6))
    plt.plot(timestamps, spb_utilizations, label="SPB Utilisation (%)", marker="o", color="green")
    plt.xlabel("Timestamp (GMT)")
    plt.ylabel("Utilisation (%)")
    plt.title("SPB Utilisation Over Time")
    plt.xticks(rotation=45, ha="right")
    plt.tight_layout()
    plt.grid()
    plt.savefig(spb_output_image)
    plt.close()
    print(f"SPB graph generated: {spb_output_image}")

# Send email with the graph as attachment
def send_email_with_graph(smtp_details, to_email, subject, body, attachment_file):
    try:
        msg = MIMEMultipart()
        msg['From'] = smtp_details['username']
        msg['To'] = to_email
        msg['Subject'] = subject

        # Attach body
        msg.attach(MIMEText(body, 'plain'))

        # Attach image
        with open(attachment_file, 'rb') as img_file:
            img = MIMEImage(img_file.read())
            img.add_header('Content-Disposition', 'attachment', filename=os.path.basename(attachment_file))
            msg.attach(img)

        # SMTP setup
        server = smtplib.SMTP(smtp_details['host'], smtp_details['port'])
        server.starttls()
        server.login(smtp_details['username'], smtp_details['password'])
        server.sendmail(msg['From'], msg['To'], msg.as_string())
        server.quit()
        print(f"Email sent to {to_email} with attachment {attachment_file}")
    except Exception as e:
        print(f"Error sending email: {e}")

# Main function
def main():
    # SFTP details
    sftp_details = {
        "host": "your.sftp.server",
        "port": 22,
        "username": "your_sftp_user",
        "password": "your_sftp_password",
    }

    # Remote and local file paths
    remote_file = "Network_devices_Backup/Api_data/api_data_20241129.csv"  # Adjust date as needed
    local_csv = "api_data.csv"
    spa_output_image = "spa_utilization_graph.png"
    spb_output_image = "spb_utilization_graph.png"

    # SMTP details
    smtp_details = {
        "host": "your.smtp.server",
        "port": 587,
        "username": "your_smtp_user",
        "password": "your_smtp_password",
    }
    to_email = "recipient@example.com"
    subject = "SPA & SPB Utilisation Graphs"
    body = "Please find the attached graphs for SPA and SPB utilisation over time."

    # Workflow
    fetch_csv_from_sftp(sftp_details, remote_file, local_csv)
    generate_graphs(local_csv, spa_output_image, spb_output_image)
    send_email_with_graph(smtp_details, to_email, subject, body, spa_output_image)
    send_email_with_graph(smtp_details, to_email, subject, body, spb_output_image)

    # Clean up local files
    os.remove(local_csv)
    os.remove(spa_output_image)
    os.remove(spb_output_image)

if __name__ == "__main__":
    main()
