import requests
from msal import ConfidentialClientApplication
import config

# Microsoft Graph API Authentication
client_id = config.CLIENT_ID
client_secret = config.CLIENT_SECRET
tenant_id = config.TENANT_ID

authority = f'https://login.microsoftonline.com/{tenant_id}'
app = ConfidentialClientApplication(client_id, authority=authority, client_credential=client_secret)
result = app.acquire_token_for_client(scopes=['https://graph.microsoft.com/.default'])

access_token = result.get('access_token')
if not access_token:
    print("Error obtaining access token.")
    exit()

headers = {"Authorization": f"Bearer {access_token}"}

# Fetch User ID
user_email = input("Enter the user's email to search for: ")
user_url = f"https://graph.microsoft.com/v1.0/users?$filter=userPrincipalName eq '{user_email}'"
user_response = requests.get(user_url, headers=headers)

if user_response.status_code == 200 and user_response.json()['value']:
    user_info = user_response.json()['value'][0]
    user_id = user_info['id']
    print(f"\nUser ID for {user_email}: {user_id}")
else:
    print(f"Error fetching User ID: {user_response.status_code}, {user_response.text}")
    exit()

# Fetch Shared Drive Files
shared_url = f"https://graph.microsoft.com/v1.0/users/{user_id}/drive/sharedWithMe"
shared_response = requests.get(shared_url, headers=headers)

if shared_response.status_code == 200:
    shared_files = shared_response.json()['value']

    if shared_files:
        print("\nShared Files:")
        for file in shared_files:
            file_name = file.get('name', 'Unknown File')
            file_id = file.get('id')
            file_link = file.get('webUrl')
            print(f"File Name: {file_name} | File ID: {file_id}")
            print(f"File Link: {file_link}\n")
    else:
        print("No shared files found.")
else:
    print(f"Error fetching shared files: {shared_response.status_code}, {shared_response.text}")
