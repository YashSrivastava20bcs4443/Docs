import smtplib
import ssl
import socket
from datetime import datetime
import OpenSSL
from email.mime.text import MIMEText
from email.mime.multipart import MIMEMultipart

# Configuration
URLS = [
    "example.com",
    "test.com",
    "yourwebsite.com"
]
SMTP_SERVER = "smtp.example.com"
SMTP_PORT = 587
SMTP_USERNAME = "your-email@example.com"
SMTP_PASSWORD = "yourpassword"
RECIPIENTS_TO = ["recipient1@example.com"]
RECIPIENTS_CC = ["recipient2@example.com"]

def get_certificate_expiry(url):
    try:
        conn = socket.create_connection((url, 443))
        context = ssl.create_default_context()
        sock = context.wrap_socket(conn, server_hostname=url)
        cert = ssl.DER_cert_to_PEM_cert(sock.getpeercert(True))
        x509 = OpenSSL.crypto.load_certificate(OpenSSL.crypto.FILETYPE_PEM, cert)
        expiry_date = datetime.strptime(x509.get_notAfter().decode('utf-8'), "%Y%m%d%H%M%SZ")
        sock.close()
        return expiry_date
    except Exception as e:
        print(f"Error fetching certificate for {url}: {e}")
        return None

def send_email(expiring_certificates):
    msg = MIMEMultipart()
    msg["From"] = SMTP_USERNAME
    msg["To"] = ", ".join(RECIPIENTS_TO)
    msg["Cc"] = ", ".join(RECIPIENTS_CC)
    msg["Subject"] = "SSL Certificate Expiry Notification"

    # Prepare HTML body
    html = """<html><body><h2>SSL Certificate Expiry Report</h2><table border='1'><tr><th>URL</th><th>Expiry Date</th><th>Days Left</th><th>Status</th></tr>"""

    for entry in expiring_certificates:
        color = "black"
        status = "Information"
        if entry['days_left'] <= 10:
            color = "red"
            status = "Urgent"
        elif entry['days_left'] <= 20:
            color = "orange"
            status = "Important"

        html += f"<tr><td>{entry['url']}</td><td>{entry['expiry_date']}</td><td>{entry['days_left']}</td><td style='color:{color}'>{status}</td></tr>"

    html += "</table></body></html>"
    msg.attach(MIMEText(html, "html"))

    # Send Email
    try:
        with smtplib.SMTP(SMTP_SERVER, SMTP_PORT) as server:
            server.starttls()
            server.login(SMTP_USERNAME, SMTP_PASSWORD)
            server.sendmail(SMTP_USERNAME, RECIPIENTS_TO + RECIPIENTS_CC, msg.as_string())
        print("Email sent successfully!")
    except Exception as e:
        print(f"Error sending email: {e}")

def main():
    expiring_certificates = []
    current_date = datetime.now()

    for url in URLS:
        expiry_date = get_certificate_expiry(url)
        if expiry_date:
            days_left = (expiry_date - current_date).days
            if days_left <= 30:
                expiring_certificates.append({
                    "url": url,
                    "expiry_date": expiry_date.strftime('%Y-%m-%d'),
                    "days_left": days_left
                })

    if expiring_certificates:
        send_email(expiring_certificates)
    else:
        print("No certificates expiring within 30 days.")

if __name__ == "__main__":
    main()
