import re

def decode_vbe(input_file, output_file):
    try:
        # Read the .vbe file
        with open(input_file, 'r', encoding='utf-8', errors='ignore') as f:
            encoded_content = f.read()

        # Debugging: Print first 50 characters to inspect the file
        print(f"First 50 characters of file: {encoded_content[:50]}")

        # Remove leading/trailing whitespace
        encoded_content = encoded_content.strip()

        # Check for #@~^ marker
        if not encoded_content.startswith('#@~^'):
            print("Error: File does not start with #@~^ marker.")
            print("This may not be a standard .vbe file.")
            return

        # Try to find encoded data with flexible regex
        match = re.search(r'#@~[\^](.*?)(==\^@#|$)', encoded_content, re.DOTALL)
        if not match:
            print("Error: Could not find encoded data between #@~^ and ==^@#.")
            print("Possible issues: Missing ==^@# marker or non-standard encoding.")
            return

        encoded_data = match.group(1)
        print(f"Found encoded data (length: {len(encoded_data)} characters)")

        # VBE encoding key table (simplified)
        key_table = [
            [chr(i) for i in range(128)],
            [chr(i) for i in range(128)],
            [chr(i) for i in range(128)]
        ]

        # Decode the script
        decoded = ''
        escape = False
        table_index = 0

        i = 0
        while i < len(encoded_data):
            char = encoded_data[i]

            if char == '@' and not escape:
                escape = True
                i += 1
                continue

            if escape:
                if char == '&':
                    decoded += '\r\n'
                elif char == '#':
                    decoded += '\r'
                elif char == '(':
                    table_index = (table_index + 1) % 3
                elif char == ')':
                    table_index = (table_index - 1) % 3
                elif char == '^':
                    decoded += '@'
                elif char == '+':
                    decoded += ' '
                elif char == '<':
                    decoded += '<'
                elif char == '>':
                    decoded += '>'
                elif char == '*':
                    decoded += '*'
                elif char == '/':
                    decoded += '/'
                else:
                    decoded += char  # Handle unexpected escape chars
                escape = False
            else:
                if ord(char) < 128:
                    decoded += key_table[table_index][ord(char)]
                else:
                    decoded += char

            i += 1

        # Write the decoded output
        with open(output_file, 'w', encoding='utf-8') as f:
            f.write(decoded)
        print(f"Decoded script written to {output_file}")

    except FileNotFoundError:
        print(f"Error: File '{input_file}' not found.")
    except Exception as e:
        print(f"Error during decoding: {str(e)}")

def main():
    # Prompt user for input and output file paths
    input_file = input("Enter the path to the .vbe file: ").strip()
    output_file = input("Enter the path for the decoded output file (e.g., decoded.vbs): ").strip()

    decode_vbe(input_file, output_file)

if __name__ == "__main__":
    main()
