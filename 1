parameters:
  - name: os_type
    displayName: "Choose OS Type"
    type: string
    default: "Linux"
    values:
      - Linux
      - Windows

  - name: vm_size
    displayName: "Choose VM Size"
    type: string
    default: "Standard_D2s_v3"
    values:
      - Standard_B1s
      - Standard_B2s
      - Standard_D2s_v3
      - Standard_D4s_v3
      - Standard_E2s_v3
      - Standard_E4s_v3

  - name: nic_count
    displayName: "Number of NICs"
    type: number
    default: 1
    values:
      - 1
      - 2

trigger: none

pool:
  vmImage: 'ubuntu-latest'

steps:
  - task: TerraformInstaller@0
    displayName: 'Install Terraform'
    inputs:
      terraformVersion: '1.3.5'

  - script: |
      terraform init
    displayName: 'Terraform Init'

  - script: |
      terraform plan \
        -var="os_type=${{ parameters.os_type }}" \
        -var="vm_size=${{ parameters.vm_size }}" \
        -var="nic_count=${{ parameters.nic_count }}"
    displayName: 'Terraform Plan'

  - script: |
      terraform apply -auto-approve \
        -var="os_type=${{ parameters.os_type }}" \
        -var="vm_size=${{ parameters.vm_size }}" \
        -var="nic_count=${{ parameters.nic_count }}"
    displayName: 'Terraform Apply'

  - script: |
      terraform destroy -auto-approve
    displayName: 'Terraform Destroy'
    condition: always()
