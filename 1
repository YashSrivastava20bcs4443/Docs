# Import required libraries
import pandas as pd
import matplotlib.pyplot as plt
import seaborn as sns
from datetime import datetime

# Load the data from Excel
file_path = 'your_excel_file.xlsx'  # Update with your Excel file path
data = pd.read_excel(file_path)

# Convert timestamp column to datetime
data['@timestamp'] = pd.to_datetime(data['@timestamp'], errors='coerce')

# Extract Day and Hour for analysis
data['Day'] = data['@timestamp'].dt.date  # Day (YYYY-MM-DD)
data['Hour'] = data['@timestamp'].dt.hour  # Hour (0-23)

# Filter relevant columns (adjust column names if necessary)
columns_to_keep = ['@timestamp', 'Event Source', 'EventNode', 'EventLevel', 'EventTitle', 'Day', 'Hour']
data = data[columns_to_keep]

### Table 1: Day-wise Analysis ###
day_wise = data.groupby(['Day', 'EventLevel']).size().unstack(fill_value=0)
day_wise['Total'] = day_wise.sum(axis=1)
print("Day-wise Event Counts:")
print(day_wise)

### Table 2: Hourly Analysis ###
hourly_analysis = data.groupby(['Hour', 'EventTitle']).size().unstack(fill_value=0)
hourly_analysis['Total'] = hourly_analysis.sum(axis=1)
print("\nHourly Event Counts:")
print(hourly_analysis)

### Graph 1: Day-wise Stacked Bar with Line Chart ###
fig, ax1 = plt.subplots(figsize=(12, 6))

# Stacked bar for daily event levels
day_wise.drop('Total', axis=1).plot(kind='bar', stacked=True, ax=ax1, colormap='viridis')

# Line plot for total counts
ax2 = ax1.twinx()
ax2.plot(day_wise.index, day_wise['Total'], color='red', marker='o', label='Total Events', linewidth=2)

# Labels and formatting
ax1.set_title('Day-wise Event Analysis (Stacked Bar + Line)', fontsize=14)
ax1.set_xlabel('Day', fontsize=12)
ax1.set_ylabel('Event Count (Stacked)', fontsize=12)
ax2.set_ylabel('Total Event Count', fontsize=12)
ax1.legend(title='Event Level')
ax2.legend(loc='upper right')
plt.xticks(rotation=45)
plt.tight_layout()
plt.show()

### Graph 2: Hourly Event Count by Title with EventSource Filter ###
# Function to plot hourly data based on EventSource
def plot_hourly_event_count(event_source):
    filtered_data = data[data['Event Source'] == event_source]
    hourly_event = filtered_data.groupby(['Hour', 'EventTitle']).size().unstack(fill_value=0)
    hourly_event['Total'] = hourly_event.sum(axis=1)

    # Plot
    fig, ax = plt.subplots(figsize=(12, 6))
    hourly_event.drop('Total', axis=1).plot(kind='bar', stacked=True, ax=ax, colormap='coolwarm')
    
    ax.set_title(f'Hourly Event Count by EventTitle (Source: {event_source})', fontsize=14)
    ax.set_xlabel('Hour of Day', fontsize=12)
    ax.set_ylabel('Event Count (Stacked)', fontsize=12)
    plt.xticks(rotation=0)
    plt.tight_layout()
    plt.show()

# Example: Plot for a specific EventSource
event_source = 'Active Batch'  # Replace with desired EventSource
plot_hourly_event_count(event_source)
