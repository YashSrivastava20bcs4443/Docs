---
- name: Backup Cisco Switches
  hosts: switches
  gather_facts: no
  vars:
    backup_base_dir: /home/
    ansible_ssh_extra_args: '-o KexAlgorithms=+diffie-hellman-group-exchange-sha1,diffie-hellman-group14-sha1'
  tasks:
    - name: Get current datetime
      set_fact:
        current_datetime: "{{ lookup('pipe', 'date +%Y-%m-%d-%H-%M-%S') }}"
    
    - name: Create backup directory for each switch if it doesn't exist
      command: "mkdir -p {{ backup_base_dir }}/{{ inventory_hostname }}"
      delegate_to: localhost

    - name: Run 'show running-config' on the Cisco switch and save locally
      expect:
        command: "ssh {{ ansible_user }}@{{ ansible_host }} 'show running-config'"
        responses:
          "assword:": "{{ ansible_ssh_pass }}"
          "(?i)continue connecting (yes/no)?": "yes"
        timeout: 60
      register: running_config

    - name: Save running configuration to file
      copy:
        content: "{{ running_config.stdout }}"
        dest: "{{ backup_base_dir }}/{{ inventory_hostname }}/{{ inventory_hostname }}_{{ current_datetime }}.cfg"
      delegate_to: localhost
