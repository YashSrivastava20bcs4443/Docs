import pandas as pd
import matplotlib.pyplot as plt

# Step 1: Read data from Excel
file_path = 'data.xlsx'  # Replace with your actual file path
sheet_name = 'Sheet1'  # Replace with your Excel sheet name

# Read the Excel file
df = pd.read_excel(file_path, sheet_name=sheet_name)

# Step 2: Clean and process the data
# Clean the @timestamp column
df['@timestamp'] = df['@timestamp'].str.replace('@', '').str.strip()

# Convert the cleaned @timestamp to datetime (be sure to handle the correct format)
df['@timestamp'] = pd.to_datetime(df['@timestamp'], format='%b %d, %Y %H:%M:%S.%f', errors='coerce')

# Check if any dates are not parsed correctly
print("Rows with invalid date format (NaT):")
print(df[df['@timestamp'].isna()])

# Step 3: Allow user to filter by a specific date
selected_date = 'Dec 2, 2024'  # Set this to any date you want to filter (or use a date input)
df['Date'] = df['@timestamp'].dt.strftime('%b %d, %Y')  # Extract date from timestamp

# Filter data for the selected date
filtered_df = df[df['Date'] == selected_date]

# Check if filtering works correctly
print(f"\nData after filtering by date {selected_date}:")
print(filtered_df.head())

# Step 4: Extract hour of the day (0 to 24) from the filtered data
filtered_df['Hour'] = filtered_df['@timestamp'].dt.hour

# Check if Hour extraction is correct
print(f"\nData with extracted Hour for {selected_date}:")
print(filtered_df[['@timestamp', 'Hour']].head())

# Step 5: Apply Filters (Optional)
# Example filter: Select rows where EventSource is "Prometheus"
filtered_df = filtered_df[filtered_df['EventSource'] == 'Prometheus']

# Ensure EventTitle exists in filtered data
if 'EventTitle' not in filtered_df.columns:
    filtered_df['EventTitle'] = 'Unknown'  # Add a placeholder if missing

# Check filtered data
print(f"\nData after applying EventSource filter (Prometheus):")
print(filtered_df.head())

# Step 6: Group data by hour and EventTitle
timewise_alerts = filtered_df.groupby(['Hour', 'EventTitle'])['EventSource'].count().unstack(fill_value=0)

# Check grouped data
print(f"\nGrouped Data by Hour and EventTitle:")
print(timewise_alerts)

# Step 7: Plot Stacked Bar Chart with Hour on X-axis (0 to 24)
fig, ax = plt.subplots(figsize=(12, 8))

# Stacked Bar Chart
timewise_alerts.plot(kind='bar', stacked=True, ax=ax, colormap='tab20')

# Customizing the plot
ax.set_title(f'Hourly Alerts by Event Title for {selected_date}')
ax.set_xlabel('Hour of the Day (0 to 24)')
ax.set_ylabel('Number of Alerts')

# Customizing x-axis to show hours from 0 to 24
ax.set_xticks(range(24))  # Set ticks for each hour (0 to 23)
ax.set_xticklabels([f'{i}:00' for i in range(24)])  # Label each tick as hour:00

# Rotate x-axis labels for better visibility
plt.xticks(rotation=45)

# Show legend and fine-tune layout
ax.legend(title='Event Title', loc='upper left', bbox_to_anchor=(1.05, 1))
plt.tight_layout()

# Display the plot
plt.show()

# Optional: Display processed data
print(f"Processed DataFrame (Time-wise Event Title for {selected_date}):")
print(timewise_alerts)
