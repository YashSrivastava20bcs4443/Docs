import os
import shutil
import time
from selenium import webdriver
from selenium.webdriver.common.by import By
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
from selenium.webdriver.chrome.service import Service
import smtplib
from email.mime.multipart import MIMEMultipart
from email.mime.text import MIMEText
from email.mime.image import MIMEImage
import config

def set_zoom(driver, zoom_level):
    driver.execute_cdp_cmd('Page.setDeviceMetricsOverride', {
        'width': 1920,
        'height': 1080,
        'deviceScaleFactor': 1,
        'mobile': False,
        'scale': zoom_level
    })
    time.sleep(2)

def access_system_health(driver, ip, username, password):
    try:
        advanced_button = WebDriverWait(driver, 10).until(EC.element_to_be_clickable((By.ID, "details-button")))
        advanced_button.click()
        proceed_link = WebDriverWait(driver, 10).until(EC.element_to_be_clickable((By.ID, "proceed-link")))
        proceed_link.click()
    except:
        print("No security warning found or bypassed.")

    # Login process
    WebDriverWait(driver, 10).until(EC.element_to_be_clickable((By.ID, "login_username"))).send_keys(username)
    WebDriverWait(driver, 10).until(EC.element_to_be_clickable((By.ID, "login_password"))).send_keys(password)
    login_button = WebDriverWait(driver, 10).until(
        EC.element_to_be_clickable((By.XPATH, "//button[@type='submit' and contains(text(), 'LOGIN')]"))
    )
    login_button.click()

    # Navigate to system health
    system_health_link = WebDriverWait(driver, 10).until(
        EC.element_to_be_clickable((By.XPATH, "//a[@routerlink='/dashboard/system-health']"))
    )
    time.sleep(10)
    system_health_link.click()
    time.sleep(10)

def take_screenshot(driver, filename):
    set_zoom(driver, 0.10)
    driver.save_screenshot(filename)
    set_zoom(driver, 1)

def send_email(owner_email, screenshot_files):
    smtp_server = ""
    smtp_port = 25
    sender_email = config.SENDER_EMAIL

    msg = MIMEMultipart()
    msg['From'] = sender_email
    msg['To'] = owner_email
    msg['Subject'] = "Vplex Health Screenshots"

    body = """
    <html>
    <body>
    <p>Hi team,</p>
    <p>Please find the Vplex Health screenshots attached below:</p>
    """
    for filename in screenshot_files:
        body += f'<p><img src="cid:{os.path.basename(filename)}"></p>'

    body += """
    <p>Thanks & Regards,<br>Yash Srivastava</p>
    </body>
    </html>
    """
    
    msg.attach(MIMEText(body, "html"))

    for filename in screenshot_files:
        with open(filename, "rb") as f:
            img = MIMEImage(f.read())
            img.add_header("Content-ID", f"<{os.path.basename(filename)}>")
            msg.attach(img)

    with smtplib.SMTP(smtp_server, smtp_port) as server:
        server.starttls()
        server.send_message(msg)

if __name__ == "__main__":
    if not os.path.exists("Temp"):
        os.mkdir("Temp")

    driver = webdriver.Chrome(service=Service("C:\\Users\\y.s.ve22\\Downloads\\syseng_sutomation\\chromedriver.exe"))
    driver.maximize_window()
    
    try:
        driver.get("https://10.1.1.18/")
        access_system_health(driver, "10.1.1.18", config.SITE_USER, config.SITE_PASSWORD)
        
        screenshot_files = []
        
        # First screenshot of System Health
        screenshot1_filename = "Temp/System_Health_screenshot.png"
        take_screenshot(driver, screenshot1_filename)
        screenshot_files.append(screenshot1_filename)
        
        # Navigate to System Status and take another screenshot
        system_status_link = WebDriverWait(driver, 10).until(
            EC.element_to_be_clickable((By.XPATH, "//a[@routerlink='/dashboard/system-status']"))
        )
        system_status_link.click()
        time.sleep(10)
        
        screenshot2_filename = "Temp/System_Status_screenshot.png"
        take_screenshot(driver, screenshot2_filename)
        screenshot_files.append(screenshot2_filename)

        # Send both screenshots in the same email
        send_email("yash.srivastava@outlook.com", screenshot_files)

    finally:
        driver.quit()
        shutil.rmtree("Temp")
