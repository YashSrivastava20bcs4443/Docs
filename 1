import re

def decode_vbe(input_file, output_file):
    try:
        # Read the .vbe file
        with open(input_file, 'r', encoding='utf-8', errors='ignore') as f:
            encoded_content = f.read()

        # Remove any leading/trailing whitespace and comments
        encoded_content = encoded_content.strip()

        # Check if the file starts with the typical #@~^ marker
        if not encoded_content.startswith('#@~^'):
            print("Error: File does not appear to be a valid .vbe file.")
            return

        # Extract the encoded data between #@~^ and ==^@#
        match = re.search(r'#@~[\^](.*?)==\^@#', encoded_content, re.DOTALL)
        if not match:
            print("Error: Could not find encoded data.")
            return

        encoded_data = match.group(1)

        # VBE encoding uses a substitution cipher with a key table
        key_table = [
            [chr(i) for i in range(128)],  # Standard ASCII
            [chr(i) for i in range(128)],  # First substitution
            [chr(i) for i in range(128)]   # Second substitution
        ]

        # Decode the script
        decoded = ''
        escape = False
        table_index = 0

        i = 0
        while i < len(encoded_data):
            char = encoded_data[i]

            if char == '@' and not escape:
                escape = True
                i += 1
                continue

            if escape:
                if char == '&':
                    decoded += '\r\n'  # Newline
                elif char == '#':
                    decoded += '\r'    # Carriage return
                elif char == '(':
                    table_index = (table_index + 1) % 3
                elif char == ')':
                    table_index = (table_index - 1) % 3
                elif char == '^':
                    decoded += '@'
                elif char == '+':
                    decoded += ' '
                elif char == '<':
                    decoded += '<'
                elif char == '>':
                    decoded += '>'
                elif char == '*':
                    decoded += '*'
                elif char == '/':
                    decoded += '/'
                escape = False
            else:
                if ord(char) < 128:
                    decoded += key_table[table_index][ord(char)]
                else:
                    decoded += char

            i += 1

        # Write the decoded output to the specified file
        with open(output_file, 'w', encoding='utf-8') as f:
            f.write(decoded)
        print(f"Decoded script written to {output_file}")

    except FileNotFoundError:
        print(f"Error: File '{input_file}' not found.")
    except Exception as e:
        print(f"Error during decoding: {str(e)}")

def main():
    # Prompt user for input and output file paths
    input_file = input("Enter the path to the .vbe file: ").strip()
    output_file = input("Enter the path for the decoded output file (e.g., decoded.vbs): ").strip()

    # Call the decode function with provided paths
    decode_vbe(input_file, output_file)

if __name__ == "__main__":
    main()
