import socket
import csv
import os
from datetime import datetime

def start_syslog_server(host='0.0.0.0', port=514, csv_file='syslog_messages.csv'):
    # Create a UDP socket
    sock = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
    sock.bind((host, port))

    print(f"Listening for syslog messages on {host}:{port}")

    # Check if the CSV file exists
    file_exists = os.path.isfile(csv_file)

    try:
        with open(csv_file, mode='a', newline='') as file:
            writer = csv.writer(file)
            # Write the header if the file is new
            if not file_exists:
                writer.writerow(['Timestamp', 'Source', 'Message'])

            while True:
                data, addr = sock.recvfrom(1024)  # buffer size is 1024 bytes
                message = data.decode('utf-8')
                timestamp = datetime.now().strftime('%Y-%m-%d %H:%M:%S')
                source = addr[0]
                print(f"Received message from {source}: {message}")
                writer.writerow([timestamp, source, message])
                file.flush()  # Ensure data is written to the file
    except KeyboardInterrupt:
        print("Syslog server stopped")
    finally:
        sock.close()

if __name__ == "__main__":
    start_syslog_server()
