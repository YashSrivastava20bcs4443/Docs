---
- name: Backup FortiGate Firewalls
  hosts: firewalls
  gather_facts: no
  vars:
    ansible_python_interpreter: /usr/bin/python3  # Adjust this path based on your environment
    ftp_server: ftp.fareportal.com.local
    ftp_user: fwbackup
    ftp_pass: D7&oVz2zf0a$1BF

  tasks:
    - name: Get current datetime
      set_fact:
        current_datetime: "{{ lookup('pipe', 'date +%Y-%m-%d-%H-%M-%S') }}"

    - name: SSH to FortiGate and take backup
      expect:
        command: ssh "{{ ansible_user }}@{{ ansible_host }}"
        responses:
          (?i)password: "{{ ansible_ssh_pass }}"
          ".*#": |
            config global
            execute backup full-config ftp {{ inventory_hostname }}_{{ current_datetime }}.conf {{ ftp_server }} {{ ftp_user }} {{ ftp_pass }}
            end
            exit
      register: backup_output
      ignore_errors: yes

    - name: Print backup output
      debug:
        var: backup_output

    - name: Fail if backup failed
      fail:
        msg: "Backup failed: {{ backup_output.stdout }}"
      when: '"Command fail" in backup_output.stdout'
