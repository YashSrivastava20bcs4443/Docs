import imaplib
from imapclient import IMAPClient
from email.header import decode_header
from datetime import datetime, timedelta
import time
from selenium import webdriver

# Outlook IMAP server details
imap_server = 'outlook.office365.com'
username = 'your_email@example.com'
password = 'your_password'

# Connect to Outlook IMAP server using imapclient
imap = IMAPClient(imap_server, ssl=True)
imap.login(username, password)

# Select the specific folder
folder_name = 'Azure'
imap.select_folder(folder_name)

# Calculate the timestamp for 30 minutes ago
thirty_minutes_ago = datetime.now() - timedelta(minutes=30)

# Search for emails with subject containing 'Azure: Activated' received in the last 30 minutes
search_criteria = ['SUBJECT "Azure: Activated"', 'SINCE {:%d-%b-%Y}'.format(thirty_minutes_ago)]
messages = imap.search(' '.join(search_criteria))

if messages:
    # Initialize Selenium WebDriver
    driver = webdriver.Chrome()
    
    for uid, message_data in imap.fetch(messages, ['RFC822']).items():
        raw_email = message_data[b'RFC822']
        msg = email.message_from_bytes(raw_email)
        
        # Extract 'View in Azure' link from the email body
        for part in msg.walk():
            if part.get_content_type() == 'text/html':
                html_body = part.get_payload(decode=True).decode()
                view_azure_link = html_body.split('View in Azure')[1].split('href="')[1].split('"')[0]
                # Open the link in browser
                driver.get(view_azure_link)
                # Take screenshot and save
                driver.save_screenshot(f'azure_portal_{uid}.png')
                break

# Logout from the server
imap.logout()

# Close the WebDriver
driver.quit()
