import subprocess
import matplotlib.pyplot as plt
from datetime import datetime
from threading import Thread
from queue import Queue
import time

# Initialize queue to store data
data_queue = Queue()

# Function to continuously ping and update queue
def ping_and_update_queue():
    while True:
        try:
            # Execute ping command
            ping_output = subprocess.run(['ping', '-n', '2', '8.8.8.8'], capture_output=True, text=True, timeout=5)
            
            # Print entire ping output
            print("Ping output:", ping_output.stdout)
            
            # Extract ping time from output
            ping_time_str = ping_output.stdout.split("\n")[1].split()[6][5:]
            print("Ping time:", ping_time_str)
            
            # Convert ping time string to float
            ping_time = float(ping_time_str)
            
            # Record timestamp and ping time
            data_queue.put((datetime.now(), ping_time))
        except Exception as e:
            print("Error occurred:", e)
        time.sleep(1)  # Sleep for 1 second before pinging again

# Start thread to continuously ping and update queue
ping_thread = Thread(target=ping_and_update_queue)
ping_thread.daemon = True  # Daemonize thread to stop when main program ends
ping_thread.start()

# Initialize lists to store data
timestamps = []
pings = []

# Continuously plot data from queue
while True:
    while not data_queue.empty():
        timestamp, ping = data_queue.get()
        timestamps.append(timestamp)
        pings.append(ping)

    # Plot data
    plt.plot(timestamps, pings, marker='o', linestyle='-')
    plt.title('Ping Time Over Time')
    plt.xlabel('Timestamp')
    plt.ylabel('Ping Time (ms)')
    plt.xticks(rotation=45)
    plt.tight_layout()
    plt.pause(5)  # Update plot every 5 seconds
    plt.clf()  # Clear plot for the next iteration
