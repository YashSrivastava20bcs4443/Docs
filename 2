# Function to send email with screenshots and API data
def send_email(owner_email, screenshot_filenames, api_data, ip):
    smtp_server = "smtp-mail.outlook.com"
    smtp_port = 25
    sender_email = config.SENDER_EMAIL
    password = config.SENDER_PASSWORD
    msg = MIMEMultipart()
    msg['From'] = sender_email
    msg['To'] = owner_email
    msg['Subject'] = f"Automated Screenshot and API Data for IP: {ip}"
    
    # Format the API data as a table with bold labels
    api_data_html = """
    <table border="1" cellpadding="5" cellspacing="0">
        <tr>
            <th><b>Free Space (TB)</b></th>
            <th><b>Total Space (TB)</b></th>
            <th><b>Used Space (TB)</b></th>
            <th><b>Preallocated Space (TB)</b></th>
        </tr>
    """
    for data in api_data:
        free_space, total_space, used_space, preallocated_space = [item.split(": ")[1] for item in data.split(", ")]
        api_data_html += f"""
        <tr>
            <td>{free_space}</td>
            <td>{total_space}</td>
            <td>{used_space}</td>
            <td>{preallocated_space}</td>
        </tr>
        """
    api_data_html += "</table>"

    # Add the table and screenshots to the email body
    body = f"""
    <html>
    <body>
        <p>Hi team,</p>
        <p>Please find the screenshots and API data attached below for IP: {ip}:</p>
        {api_data_html}
        {''.join([f'<p><img src="cid:{os.path.basename(filename)}"></p>' for filename in screenshot_filenames])}
        <p>Thanks & Regards,<br> Yash Srivastava</p>
    </body>
    </html>
    """
    
    msg.attach(MIMEText(body, "html"))

    for filename in screenshot_filenames:
        with open(filename, "rb") as f:
            img = MIMEImage(f.read())
            img.add_header("Content-Disposition", "inline", filename=os.path.basename(filename))
            img.add_header("Content-ID", f"<{os.path.basename(filename)}>")
            msg.attach(img)

    with smtplib.SMTP(smtp_server, smtp_port) as server:
        server.starttls()
        server.login(sender_email, password)
        server.send_message(msg)
