if __name__ == "__main__":
    # Get access token
    auth_token = get_access_token()

    # Define time range in UTC (last 1 hour)
    end_date = datetime.now(timezone.utc).strftime('%Y-%m-%dT%H:%M:%SZ')
    start_date = (datetime.now(timezone.utc) - timedelta(hours=1)).strftime('%Y-%m-%dT%H:%M:%SZ')

    # Fetch and process data
    data = fetch_data(start_date, end_date, auth_token)

    if data:
        csv_file_path = save_raw_data_to_csv(data)

        # Connect to PostgreSQL
        db_conn = psycopg2.connect(**DB_CONFIG)

        # Load the CSV into a DataFrame
        df = pd.read_csv(csv_file_path)

        # Replace NaT, NaN, and "nan" with None
        df.replace({pd.NA: None, "NaN": None, "nan": None}, inplace=True)

        # Call the function with the cleaned DataFrame
        create_table_and_insert_data(db_conn, "yash", df)

        delete_csv(csv_file_path)  # Remove CSV after inserting data
        db_conn.close()
    else:
        print("No data fetched for the given time range.")
