sudo waagent -deprovision+user


how to access win vm from console:
cmd
ch -si 1
ch
powershell


C:\Windows\System32\Sysprep\sysprep.exe /generalize /shutdown /oobe


# Create the gallery (if not already done)
az sig create --resource-group use1-dr-rgp01 --gallery-name use1-drd-GoldenImages

# Linux: Ubuntu 22.04 LTS (Gen1 assumed; adjust to V2 if your VM is Gen2)


az sig image-definition create --resource-group use1-dr-rgp01 --gallery-name use1-drd-GoldenImages --gallery-image-definition UbuntuGoldenImage --publisher Custom --offer Ubuntu --sku 22_04-lts --os-type Linux --hyper-v-generation V1


az sig image-version create --resource-group use1-dr-rgp01 --gallery-name use1-drd-GoldenImages --gallery-image-definition UbuntuGoldenImage --gallery-image-version 1.0.0 --virtual-machine "/subscriptions/sub-id/resourceGroups/use1-dr-rgp01/providers/Microsoft.Compute/virtualMachines/ubuntu-vm-1" --target-regions eastus

# Windows: Windows Server 2022 (Gen1 assumed; adjust to V2 if your VM is Gen2)

az sig image-definition create --resource-group use1-dr-rgp01 --gallery-name use1-drd-GoldenImages --gallery-image-definition WindowsGoldenImage --publisher Custom --offer WindowsServer --sku 2022-Datacenter --os-type Windows --hyper-v-generation V1


az sig image-version create --resource-group use1-dr-rgp01 --gallery-name use1-drd-GoldenImages --gallery-image-definition WindowsGoldenImage --gallery-image-version 1.0.0 --virtual-machine "/subscriptions/sub-id/resourceGroups/use1-dr-rgp01/providers/Microsoft.Compute/virtualMachines/win-vm-1" --target-regions eastus


az vm deallocate --resource-group use1-dr-rgp01 --name ubuntu-vm-1
az vm generalize --resource-group use1-dr-rgp01 --name ubuntu-vm-1


az vm deallocate --resource-group use1-dr-rgp01 --name win-vm-1
az vm generalize --resource-group use1-dr-rgp01 --name win-vm-1

