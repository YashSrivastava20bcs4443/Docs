import time
import os
from urllib.parse import urlparse
from selenium.webdriver.common.by import By
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
from selenium.webdriver.common.action_chains import ActionChains

# Find all rows containing alerts
rows = driver.find_elements(By.XPATH, "//div[contains(@class, 'fxc-gc-row')]")

# Counter to track the number of processed alerts
alert_count = 0

# Iterate through each row containing an alert
for index, row in enumerate(rows, 1):
    try:
        # Re-find the row element to avoid stale element reference
        row = driver.find_elements(By.XPATH, "//div[contains(@class, 'fxc-gc-row')]")[index - 1]
        
        # Find the third column in the row
        third_column = row.find_element(By.XPATH, ".//div[contains(@class, 'fxc-gc-cell')][3]//a[@class='fxc-gcflink-link']")
        
        # Scroll to the element
        actions = ActionChains(driver)
        actions.move_to_element(third_column).perform()
        
        # Wait for the element to be clickable
        WebDriverWait(driver, 10).until(EC.element_to_be_clickable((By.XPATH, ".//div[contains(@class, 'fxc-gc-cell')][3]//a[@class='fxc-gcflink-link']")))
        
        # Re-find the element to avoid stale element reference
        third_column = row.find_element(By.XPATH, ".//div[contains(@class, 'fxc-gc-cell')][3]//a[@class='fxc-gcflink-link']")
        
        # Get the URL of the link
        link_url = third_column.get_attribute("href")
        
        # Extract the filename from the URL
        filename = os.path.basename(urlparse(link_url).path)
        
        # Execute JavaScript to click on the third column
        driver.execute_script("arguments[0].click();", third_column)
        
        # Wait for the new page to load
        time.sleep(5)  # You might need to adjust the wait time
        
        # Take a screenshot of the page with the custom filename
        driver.save_screenshot(f"{filename}_{index}.png")
        
        # Increment the alert count
        alert_count += 1
        
        # If 10 alerts have been processed, break out of the loop
        if alert_count == 10:
            break
        
        # Go back to the previous page (the alert details)
        driver.back()
        
        # Wait for the page to load
        time.sleep(5)  # You might need to adjust the wait time
    
    except Exception as e:
        print(f"An error occurred: {str(e)}")
        # Retry locating the element
        continue
